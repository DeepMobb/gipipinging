<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIPI - Encrypted Pinging Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .gipi-logo-char { display: inline-block; opacity: 0; transform: translateY(20px); animation: fadeInChar 0.5s forwards; }
        @keyframes fadeInChar { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutScreen { to { opacity: 0; transform: scale(0.95); } }
        @keyframes fadeInScreen { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-out { animation: fadeOutScreen 0.5s ease-in-out forwards; }
        .animate-fade-in { animation: fadeInScreen 0.5s ease-in-out forwards; }
        #qr-scanner video, #face-scan-video { width: 100% !important; height: auto !important; border-radius: 1.5rem; transform: scaleX(-1); }
        .chat-bubble { max-width: 75%; }
        .chat-bubble-user { background-color: #0052A2; color: white; align-self: flex-end; }
        .chat-bubble-peer { background-color: #333; color: white; align-self: flex-start; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .animate-pulse-subtle { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-black text-white h-full overflow-hidden">

    <!-- Container for all screens -->
    <div id="app-container" class="h-full">
        <!-- All screens from previous step remain identical -->
        <div id="loading-screen" class="h-full flex items-center justify-center bg-black">
            <div class="text-center">
                <h1 class="text-8xl font-black tracking-tighter" aria-label="GIPI">
                    <span class="gipi-logo-char" style="animation-delay: 0.1s;">G</span>
                    <span class="gipi-logo-char" style="animation-delay: 0.2s;">I</span>
                    <span class="gipi-logo-char" style="animation-delay: 0.3s;">P</span>
                    <span class="gipi-logo-char" style="animation-delay: 0.4s;">I</span>
                </h1>
                <p class="text-lg text-gray-400 mt-2 tracking-widest">S E C U R E . P I N G</p>
            </div>
        </div>
        <div id="main-screen" class="hidden h-full flex flex-col items-center justify-center p-8 text-center bg-black"></div>
        <div id="goodbye-screen" class="hidden h-full flex items-center justify-center p-8 text-center bg-black"><div class="animate-fade-in"><h2 class="text-4xl font-bold text-gray-700">Connection Terminated.</h2><p class="text-gray-500 mt-4">Come back when you are ready to ping with GIPI.</p></div></div>
        <div id="qr-generator-screen" class="hidden h-full flex flex-col items-center justify-center p-8 bg-black"><div class="animate-fade-in w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-4">Your Ping QR</h2><p id="qr-status-text" class="text-gray-400 mb-8">Have your peer scan this to connect.</p><div id="qrcode" class="p-6 bg-white rounded-3xl flex items-center justify-center"></div><button onclick="goHome()" class="mt-12 w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-full transition-colors duration-300">Back</button></div></div>
        <div id="qr-scanner-screen" class="hidden h-full flex flex-col items-center justify-center p-8 bg-black"><div class="animate-fade-in w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-4">Scan and Connect</h2><p class="text-gray-400 mb-8">Point your camera at a GIPI QR code.</p><div id="qr-scanner" class="w-full aspect-square rounded-3xl overflow-hidden bg-gray-900"></div><button onclick="stopScannerAndGoBack()" class="mt-8 w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-full transition-colors duration-300">Cancel</button></div></div>
        <div id="connected-screen" class="hidden h-full flex flex-col p-6 bg-black"><div class="animate-fade-in flex-grow"><h2 class="text-3xl font-bold mb-8">Connected Peers</h2><div class="bg-gray-900/50 p-4 rounded-2xl mb-4 flex items-center justify-between"><div><p class="font-bold text-lg" id="local-username-display"></p><p class="text-sm text-gray-400">You</p></div></div><div id="peer-profile-box" class="bg-gray-900 p-4 rounded-2xl flex items-center justify-between"><div><p class="font-bold text-lg" id="peer-username-display"></p><p class="text-sm text-gray-400">Peer</p></div><button id="ping-user-button" onclick="initiatePing()" class="bg-[#0052A2] hover:bg-[#004182] text-white font-bold py-2 px-5 rounded-full transition-colors duration-300">Ping</button></div><div id="connection-status" class="text-center text-yellow-400 mt-6 hidden"></div></div><button onclick="shatterConnection()" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-full transition-colors duration-300">Shatter Connection</button></div>
        <div id="face-scan-screen" class="hidden h-full flex flex-col items-center justify-center p-8 bg-black"><div class="animate-fade-in w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-4">Facial Proof</h2><p class="text-gray-400 mb-8">Center your face in the camera to verify.</p><div class="w-full aspect-square rounded-full overflow-hidden bg-gray-900 flex items-center justify-center"><video id="face-scan-video" autoplay playsinline class="hidden"></video></div><button id="face-scan-button" onclick="sendFaceScan()" class="mt-8 w-full bg-[#0052A2] hover:bg-[#004182] text-white font-bold py-4 px-6 rounded-full transition-colors duration-300">Scan Face & Send</button><canvas id="face-scan-canvas" class="hidden"></canvas></div></div>
        <div id="chat-room-screen" class="hidden h-full flex flex-col bg-black"><header class="p-4 border-b border-gray-800 flex items-center justify-between"><h2 class="text-xl font-bold" id="chat-header-username"></h2><button onclick="shatterConnection()" class="text-sm text-red-500 hover:text-red-400">Shatter</button></header><main id="chat-messages" class="flex-grow p-4 flex flex-col gap-3 overflow-y-auto"></main><footer class="p-4 border-t border-gray-800"><div class="flex items-center gap-2"><input id="chat-input" type="text" placeholder="Start a new message" class="flex-grow bg-gray-800 text-white rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[#0052A2]"><button onclick="sendMessage()" class="bg-[#0052A2] hover:bg-[#004182] text-white rounded-full p-3"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button></div></footer></div>
    </div>
    
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-8 z-50 hidden"><div id="ping-request-modal" class="bg-gray-900 rounded-3xl p-8 w-full max-w-sm text-center hidden animate-fade-in"><h3 class="text-2xl font-bold mb-2">Ping Request</h3><p class="text-gray-400 mb-6" id="ping-request-user-text"></p><img id="ping-request-image" src="" class="rounded-2xl mb-6 w-full object-cover aspect-square"><div class="flex gap-4"><button onclick="declinePingRequest()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-full transition-colors duration-300">Decline</button><button onclick="acceptPingRequest()" class="flex-1 bg-[#0052A2] hover:bg-[#004182] text-white font-bold py-3 px-5 rounded-full transition-colors duration-300">Accept & Reply</button></div></div></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & FIREBASE ---
        let db, auth;
        let unsubscribeConnection = null;
        let unsubscribeMessages = null;

        let currentState = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'gipi-app-default',
            currentScreen: 'loading-screen',
            connectionId: null,
            peerUsername: null,
            localUsername: null,
            userId: null,
            isAuthReady: false,
        };
        const LS_KEY = 'gipi_state';

        // --- INITIALIZATION ---
        window.onload = function() {
            // ACTION REQUIRED: Paste your Firebase configuration object here.
            // You can get this from your Firebase project settings.
            // Go to Project Settings > General > Your apps > Web app > Firebase SDK snippet > Config
            const firebaseConfig = {
                apiKey: "AIzaSyDS6IGHzcctU7ilJs4n0T2CLGy4_zGn0Go",
                authDomain: "gipi-71915.firebaseapp.com",
                projectId: "gipi-71915",
                storageBucket: "gipi-71915.appspot.com",
                messagingSenderId: "674633621539",
                appId: "1:674633621539:web:cc6453a2e219ce6a359196"
            };

            const finalConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

            // Check if the placeholder config is still being used when running locally.
            if (finalConfig.apiKey.startsWith("PASTE_YOUR")) {
                console.error("Firebase configuration is missing or incomplete.");
                alert("ACTION REQUIRED: You need to paste your Firebase project configuration into the index.html file to connect the app. Please see the comments in the <script> tag.");
                changeScreen('goodbye-screen');
                return;
            }

            const app = initializeApp(finalConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            loadState(); // Load local state first
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentState.userId = user.uid;
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                         console.error("Anonymous sign-in failed:", error);
                         changeScreen('goodbye-screen');
                    }
                }
                
                if (!currentState.isAuthReady) {
                    currentState.isAuthReady = true;
                    initializeAppLogic();
                }
            });
        };
        
        function initializeAppLogic() {
            checkInactivity();
            
            if (currentState.connectionId) {
                // If we have a connectionId, listen to it
                listenToConnection(currentState.connectionId);
            } else if (currentState.currentScreen === 'loading-screen') {
                 setTimeout(() => {
                    renderMainScreen('permission');
                    changeScreen('main-screen');
                }, 3000);
            } else {
                // Restore previous non-connected screen
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById(currentState.currentScreen).classList.remove('hidden');
                if(currentState.currentScreen === 'main-screen') renderMainScreen('buttons');
            }
        }
        
        // --- SCREEN MANAGEMENT ---
        const screens = [
            'loading-screen', 'main-screen', 'goodbye-screen', 
            'qr-generator-screen', 'qr-scanner-screen', 'connected-screen',
            'face-scan-screen', 'chat-room-screen'
        ];
        function changeScreen(newScreenId, skipAnimation = false) {
            stopCamera();
            const oldScreenId = currentState.currentScreen;
            if (oldScreenId === newScreenId) return;

            const oldScreen = document.getElementById(oldScreenId);
            const newScreen = document.getElementById(newScreenId);
            
            function switchScreens() {
                if (oldScreen) oldScreen.classList.add('hidden');
                if (newScreen) newScreen.classList.remove('hidden');
                if(newScreen && !skipAnimation) newScreen.classList.add('animate-fade-in');
                currentState.currentScreen = newScreenId;
                saveState();
            }
            if (oldScreen && !skipAnimation) {
                oldScreen.classList.add('animate-fade-out');
                setTimeout(switchScreens, 400);
            } else {
                switchScreens();
            }
        }

        // --- MAIN FLOW & QR ---
        async function generateQR() {
            if (!currentState.isAuthReady) return alert("Connecting...");
            currentState.localUsername = currentState.localUsername || generateRandomUsername();
            
            const connectionId = 'gipi-' + auth.currentUser.uid + '-' + Date.now();
            currentState.connectionId = connectionId;

            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = ''; 
            const qrData = JSON.stringify({ connectionId, username: currentState.localUsername, userId: auth.currentUser.uid });
            new QRCode(qrElement, { text: qrData, width: 256, height: 256 });
            
            listenToConnection(connectionId);
            changeScreen('qr-generator-screen');

            const statusText = document.getElementById('qr-status-text');
            statusText.textContent = "Listening for connection...";
            statusText.classList.add('animate-pulse-subtle');
        }

        function onScanSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                if(data.connectionId && data.connectionId.startsWith('gipi-') && data.username && data.userId) {
                    html5QrCode.stop();
                    currentState.connectionId = data.connectionId;
                    currentState.peerUsername = data.username;
                    currentState.localUsername = currentState.localUsername || generateRandomUsername();
                    
                    listenToConnection(data.connectionId);
                    
                    // Proceed to send facial proof
                    changeScreen('connected-screen');
                    setupConnectedScreenDOM();
                    initiatePing();
                }
            } catch (e) { /* ignore */ }
        }

        // --- FIREBASE LISTENERS ---
        function listenToConnection(connectionId) {
            if (unsubscribeConnection) unsubscribeConnection();
            
            const docRef = doc(db, "artifacts", currentState.appId, "public/data/pings", connectionId);

            unsubscribeConnection = onSnapshot(docRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Document was deleted (connection shattered)
                    if (currentState.connectionId) goHome();
                    return;
                }

                const data = docSnap.data();
                
                // Update peer username if we are the receiver
                if (data.initiatorUsername && auth.currentUser.uid === data.receiverId) {
                    currentState.peerUsername = data.initiatorUsername;
                }
                
                switch(data.status) {
                    case 'awaiting-reply':
                        // This is for the receiver
                        if (auth.currentUser.uid === data.receiverId) {
                            document.getElementById('ping-request-user-text').textContent = `${data.initiatorUsername} wants to connect.`;
                            document.getElementById('ping-request-image').src = data.initiatorFaceProof;
                            showModal('ping-request-modal');
                        }
                        break;
                    
                    case 'connected':
                        if (unsubscribeMessages) unsubscribeMessages(); // Stop previous message listener if any
                        listenToMessages(connectionId);
                        changeScreen('chat-room-screen');
                        setupChatRoomDOM();
                        updateLastActivity();
                        break;

                    case 'declined':
                         if (auth.currentUser.uid === data.initiatorId) {
                            alert("Your connection request was declined.");
                            goHome();
                         }
                        break;
                }
            });
        }
        
        function listenToMessages(connectionId) {
            const messagesRef = collection(db, "artifacts", currentState.appId, "public/data/pings", connectionId, "messages");
            const q = query(messagesRef, orderBy("timestamp"));

            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push(doc.data());
                });
                renderMessages(messages);
            });
        }

        // --- FIREBASE ACTIONS ---
        async function sendFaceScan() {
            const faceScanButton = document.getElementById('face-scan-button');
            faceScanButton.disabled = true;
            faceScanButton.textContent = "Sending...";

            const faceProofUrl = captureFaceProof();
            stopCamera();

            const docRef = doc(db, "artifacts", currentState.appId, "public/data/pings", currentState.connectionId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                // We are the initiator, creating the request
                await setDoc(docRef, {
                    initiatorId: auth.currentUser.uid,
                    initiatorUsername: currentState.localUsername,
                    initiatorFaceProof: faceProofUrl,
                    receiverId: null, // This will be set by the QR data, but we don't know it yet. A Cloud Function could fix this.
                    receiverUsername: currentState.peerUsername,
                    status: 'awaiting-reply',
                    createdAt: serverTimestamp()
                });
                changeScreen('connected-screen');
                setupConnectedScreenDOM();
                showAwaitingStatus();
            } else {
                // We are the receiver, accepting the request
                await updateDoc(docRef, {
                    receiverFaceProof: faceProofUrl,
                    status: 'connected'
                });
                // The onSnapshot listener will handle screen change
            }
            faceScanButton.disabled = false;
            faceScanButton.textContent = "Scan Face & Send";
        }

        async function acceptPingRequest() {
            hideModal();
            const docRef = doc(db, "artifacts", currentState.appId, "public/data/pings", currentState.connectionId);
            await updateDoc(docRef, {
                receiverId: auth.currentUser.uid,
                receiverUsername: currentState.localUsername,
            });
            await startCamera('face-scan-video');
            changeScreen('face-scan-screen');
        }

        async function declinePingRequest() {
            hideModal();
            const docRef = doc(db, "artifacts", currentState.appId, "public/data/pings", currentState.connectionId);
            await updateDoc(docRef, { status: 'declined' });
            // The initiator's listener will alert them. We can go home.
            goHome();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                input.value = '';
                const messagesRef = collection(db, "artifacts", currentState.appId, "public/data/pings", currentState.connectionId, "messages");
                await addDoc(messagesRef, {
                    text: text,
                    senderId: auth.currentUser.uid,
                    timestamp: serverTimestamp()
                });
                updateLastActivity();
            }
        }
        
        async function shatterConnection() {
            if (!currentState.connectionId) return;
            const connectionIdToDelete = currentState.connectionId;
            goHome(); // Go home immediately for snappy UX
            
            try {
                const docRef = doc(db, "artifacts", currentState.appId, "public/data/pings", connectionIdToDelete);
                await deleteDoc(docRef);
            } catch (e) {
                console.error("Error shattering connection:", e);
            }
        }

        // --- UI & DOM MANIPULATION ---
        function setupConnectedScreenDOM() {
            document.getElementById('local-username-display').textContent = currentState.localUsername;
            document.getElementById('peer-username-display').textContent = currentState.peerUsername;
            document.getElementById('connection-status').classList.add('hidden');
            document.getElementById('ping-user-button').classList.remove('hidden');
            document.getElementById('ping-user-button').disabled = false;
            document.getElementById('ping-user-button').textContent = "Ping";
        }
        
        function setupChatRoomDOM() {
             document.getElementById('chat-header-username').textContent = currentState.peerUsername;
        }

        function renderMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.textContent = msg.text;
                bubble.classList.add('chat-bubble', 'p-3', 'rounded-2xl');
                const isUser = msg.senderId === auth.currentUser.uid;
                bubble.classList.add(isUser ? 'chat-bubble-user' : 'chat-bubble-peer');
                messagesContainer.appendChild(bubble);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // --- ALL OTHER FUNCTIONS (UTILITIES, CAMERA, STATE) ---
        // These functions are largely unchanged from the previous version.
        
        // State Management
        function saveState() { try { localStorage.setItem(LS_KEY, JSON.stringify(currentState)); } catch (e) { console.error("Could not save state.", e); }}
        function loadState() { try { const s = localStorage.getItem(LS_KEY); if (s) { const parsed = JSON.parse(s); currentState.connectionId = parsed.connectionId; currentState.localUsername = parsed.localUsername; } } catch (e) { console.error("Could not load state.", e); }}
        function updateLastActivity() { localStorage.setItem('gipi_last_activity', new Date().toISOString()); }
        function checkInactivity() { const la = localStorage.getItem('gipi_last_activity'); if (la) { const d = new Date(la); const t = new Date(); t.setDate(t.getDate() - 30); if (d < t) { shatterConnection(); } } }

        // Navigation & Cleanup
        function goHome() {
            if (unsubscribeConnection) unsubscribeConnection();
            if (unsubscribeMessages) unsubscribeMessages();
            unsubscribeConnection = null;
            unsubscribeMessages = null;
            
            currentState.connectionId = null;
            currentState.peerUsername = null;
            
            renderMainScreen('buttons');
            changeScreen('main-screen');
            saveState();
        }
        window.goHome = goHome; // Make available to onclick

        // Camera
        let cameraStream = null;
        async function startCamera(videoId) { stopCamera(); try { const c = { video: { facingMode: 'user' } }; cameraStream = await navigator.mediaDevices.getUserMedia(c); document.getElementById(videoId).srcObject = cameraStream; document.getElementById(videoId).classList.remove('hidden'); } catch (err) { alert('Could not access camera.'); goHome(); } }
        function stopCamera() { if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; } }
        function captureFaceProof() { const v = document.getElementById('face-scan-video'); const c = document.getElementById('face-scan-canvas'); c.width = v.videoWidth; c.height = v.videoHeight; const ctx = c.getContext('2d'); ctx.scale(-1, 1); ctx.drawImage(v, -c.width, 0, c.width, c.height); return c.toDataURL('image/jpeg', 0.8); }
        
        // QR Scanner
        let html5QrCode = null;
        function startScanner() { changeScreen('qr-scanner-screen'); html5QrCode = new Html5Qrcode("qr-scanner"); const config = { fps: 10, qrbox: { width: 250, height: 250 } }; html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess).catch(err => { alert("Could not start camera."); goHome(); }); }
        function stopScannerAndGoBack() { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().finally(() => { html5QrCode = null; goHome(); }); } else { goHome(); } }
        
        // Modals
        function showModal(id) { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); }
        function hideModal() { document.getElementById('modal-container').classList.add('hidden'); document.querySelectorAll('#modal-container > div').forEach(m => m.classList.add('hidden')); }
        
        // Misc UI
        function showAwaitingStatus() { document.getElementById('connection-status').textContent = "Awaiting connection request..."; document.getElementById('connection-status').classList.remove('hidden'); document.getElementById('ping-user-button').disabled = true; document.getElementById('ping-user-button').textContent = "Pending"; }
        function renderMainScreen(view) { const el=document.getElementById('main-screen'); if(view === 'permission'){el.innerHTML = `<div class="animate-fade-in"><h2 class="text-4xl font-bold">Welcome to GIPI.</h2><p class="text-gray-400 mt-4 max-w-md mx-auto">To receive secure pings, we need to send notifications.</p><button onclick="requestNotifications()" class="mt-8 bg-white hover:bg-gray-200 text-black font-bold py-4 px-8 rounded-full">Allow Notifications</button><button onclick="declineNotifications()" class="mt-4 text-gray-500 hover:text-gray-400">Maybe later</button></div>`;}else{el.innerHTML = `<div class="animate-fade-in w-full max-w-sm"><h1 class="text-6xl font-black tracking-tighter mb-12">GIPI</h1><div class="space-y-4"><button onclick="generateQR()" class="w-full bg-white text-black font-bold py-5 px-6 rounded-full text-lg">Show Ping QR</button><button onclick="startScanner()" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-5 px-6 rounded-full text-lg">Scan and Connect</button></div></div>`;}}
        function requestNotifications(){ renderMainScreen('buttons'); }
        function declineNotifications(){ changeScreen('goodbye-screen'); }
        function generateRandomUsername() { const a = ["Aqua", "Cosmic", "Dark", "Echo", "Future", "Ghost"]; const n = ["Agent", "Bot", "Cortex", "Droid", "Entity", "Fox"]; return `${a[Math.floor(Math.random()*a.length)]}${n[Math.floor(Math.random()*n.length)]}${Math.floor(100+Math.random()*900)}`; }
        async function initiatePing() { await startCamera('face-scan-video'); changeScreen('face-scan-screen'); }

        // Expose functions to global scope for onclick attributes
        Object.assign(window, {
            requestNotifications, declineNotifications, generateQR, startScanner, stopScannerAndGoBack,
            initiatePing, sendFaceScan, shatterConnection, sendMessage, acceptPingRequest, declinePingRequest
        });
    </script>
</body>
</html>


